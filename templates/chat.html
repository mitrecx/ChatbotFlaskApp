<!DOCTYPE html>
<html>
<body>
    <input type="text" id="questionInput" placeholder="输入你的问题">
    <button onclick="startChat()">发送</button>
    <div id="output" style="white-space: pre-wrap; margin-top: 20px;"></div>

    <script>
        let abortController = null;
        let currentProcessor = null;

        async function startChat() {
            // 终止之前的请求
            if (abortController) {
                abortController.abort();
                currentProcessor?.abort?.();
            }

            const question = document.getElementById('questionInput').value;
            const outputEl = document.getElementById('output');

            // 创建新的回答区域
            const answerDiv = document.createElement('div');
            answerDiv.classList.add('answer');
            outputEl.appendChild(answerDiv);

            // 添加用户问题展示
            const questionDiv = document.createElement('div');
            questionDiv.style.color = '#666';
            questionDiv.textContent = `用户：${question}`;
            outputEl.appendChild(questionDiv);

            abortController = new AbortController();

            try {
                const response = await fetch('/chat-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: question }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                currentProcessor = {
                    abort: () => reader.cancel()
                };

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value);
                    // 批量更新减少DOM操作
                    if (buffer.length > 5 || buffer.includes('\n')) {
                        answerDiv.textContent += buffer;
                        buffer = '';
                        // 自动滚动到底部
                        answerDiv.scrollIntoView({ behavior: 'smooth' });
                    }
                }
                answerDiv.textContent += buffer; // 处理剩余内容
            } catch (err) {
                if (err.name !== 'AbortError') {
                    answerDiv.textContent += '\n[请求中断]';
                    console.error('请求失败:', err);
                }
            }
        }
    </script>

    <style>
        .answer {
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid #4CAF50;
        }
    </style>
</body>
</html>